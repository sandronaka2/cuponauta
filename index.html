<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cuponauta - WhatsApp</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #075e54, #128c7e);
      padding: 20px 30px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 15px rgba(0,0,0,0.5);
    }

    .header h1 {
      font-size: 24px;
      color: #fff;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 13px;
      color: #d1f5d3;
    }

    .tab-bar {
      display: flex;
      background: #111;
      border-bottom: 1px solid #222;
      overflow-x: auto;
      position: sticky;
      top: 76px;
      z-index: 99;
    }

    .tab-bar::-webkit-scrollbar { height: 3px; }
    .tab-bar::-webkit-scrollbar-track { background: #111; }
    .tab-bar::-webkit-scrollbar-thumb { background: #25d366; border-radius: 3px; }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 13px;
      font-weight: 600;
      color: #888;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .tab:hover { color: #ccc; background: #1a1a1a; }

    .tab.active {
      color: #25d366;
      border-bottom-color: #25d366;
    }

    .tab .badge {
      background: #25d366;
      color: #000;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 10px;
      margin-left: 6px;
      font-weight: 700;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 15px;
    }

    .category-section { display: none; }
    .category-section.active {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .copy-all-btn {
      grid-column: 1 / -1;
    }

    .product-card {
      background: #161616;
      border: 1px solid #252525;
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .product-card:hover { border-color: #25d366; }

    .product-inner {
      display: flex;
      gap: 16px;
      padding: 16px;
    }

    .product-img {
      width: 110px;
      height: 110px;
      border-radius: 8px;
      object-fit: cover;
      background: #222;
      flex-shrink: 0;
    }

    .product-info {
      flex: 1;
      min-width: 0;
    }

    .product-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-prices {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .price-original {
      font-size: 12px;
      color: #666;
      text-decoration: line-through;
    }

    .price-current {
      font-size: 18px;
      font-weight: 700;
      color: #25d366;
    }

    .discount-badge {
      background: #ff4444;
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .product-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .meta-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      background: #1e1e1e;
      color: #aaa;
      border: 1px solid #333;
    }

    .meta-tag.coupon {
      background: #1a2e1a;
      color: #25d366;
      border-color: #25d366;
    }

    .meta-tag.seller {
      background: #1a1a2e;
      color: #6ea8fe;
      border-color: #3a3a5e;
    }

    .meta-tag.highlight {
      background: #2e1a1a;
      color: #ff6b6b;
      border-color: #5e3a3a;
    }

    .whats-text-area {
      background: #0d1117;
      border-top: 1px solid #252525;
      padding: 12px 16px;
      position: relative;
    }

    .whats-text {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #c9d1d9;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
      user-select: all;
      padding-right: 50px;
    }

    .copy-btn {
      background: #25d366;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .copy-btn:hover { background: #20bd5a; transform: scale(1.05); }

    .share-btns {
      display: flex;
      gap: 8px;
      padding: 10px 16px;
      background: #0d1117;
      border-top: 1px solid #252525;
    }

    .share-btn {
      flex: 1;
      background: #25d366;
      color: #fff;
      border: none;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .share-btn:hover { background: #20bd5a; transform: scale(1.02); }
    .share-btn.loading { opacity: 0.6; cursor: wait; }
    .share-btn.success { background: #1a8; }
    .share-btn.error { background: #c44; }

    .share-btn-secondary {
      flex: 1;
      background: #1a1a2e;
      color: #6ea8fe;
      border: 1px solid #3a3a5e;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      text-decoration: none;
      display: block;
    }

    .share-btn-secondary:hover { background: #252540; }

    .whats-send-btn {
      position: absolute;
      top: 10px;
      right: 12px;
    }

    .score-bar {
      width: 60px;
      height: 4px;
      background: #333;
      border-radius: 2px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-left: 6px;
    }

    .score-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s;
    }

    .rank-number {
      font-size: 11px;
      font-weight: 700;
      color: #555;
      margin-right: 4px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 16px;
    }

    .loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #25d366;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 10px;
      background: #111;
      border-bottom: 1px solid #222;
      font-size: 12px;
      color: #666;
    }

    .stats-bar strong { color: #25d366; }

    .copy-all-btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: #25d366;
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 0;
      transition: all 0.2s;
    }

    .copy-all-btn:hover { background: #20bd5a; }
    .copy-all-btn.copied { background: #fff; }

    @media (max-width: 768px) {
      .category-section.active {
        grid-template-columns: 1fr;
      }
      .product-inner { flex-direction: column; align-items: center; text-align: center; }
      .product-img { width: 140px; height: 140px; }
      .product-prices { justify-content: center; }
      .product-meta { justify-content: center; }
      .header h1 { font-size: 20px; }
      .tab { padding: 10px 14px; font-size: 12px; }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>ü§ñ Cuponauta WhatsApp</h1>
    <p>Top 30 produtos por categoria ‚Äî prontos para copiar e enviar</p>
  </div>

  <div class="stats-bar" id="statsBar">
    <span>Carregando...</span>
  </div>

  <div class="tab-bar" id="tabBar"></div>

  <div class="container" id="content">
    <div class="loading">
      <div class="spinner"></div>
      Carregando produtos...
    </div>
  </div>

  <script>
    // Base URL para p√°ginas de produto com OG tags
    const SITE_BASE = window.location.href.replace(/[^/]*$/, '');

    const CATEGORY_EMOJIS = {
      'Tech & Eletr√¥nicos': 'üì±',
      'Casa, Eletros & Utilidades': 'üè†',
      'Moda & Acess√≥rios': 'üëó',
      'Beleza, Sa√∫de & Bem-Estar': 'üíÑ',
      'Games & Hobbies': 'üéÆ',
    };

    const CATEGORY_ORDER = [
      'Tech & Eletr√¥nicos',
      'Casa, Eletros & Utilidades',
      'Moda & Acess√≥rios',
      'Beleza, Sa√∫de & Bem-Estar',
      'Games & Hobbies',
    ];

    let allData = {};
    let serverLastRefresh = null;
    const productMap = {};

    async function loadProducts() {
      try {
        const res = await fetch('products.json');
        if (!res.ok) throw new Error('Erro HTTP ' + res.status);
        const json = await res.json();
        allData = json.data;
        serverLastRefresh = json.lastRefresh;
        renderPage();
      } catch (err) {
        document.getElementById('content').innerHTML =
          '<div class="loading" style="color:#ff4444;">Erro ao carregar: ' + err.message + '</div>';
      }
    }

    function buildWhatsText(p) {
      let text = '';
      text += 'ü§ñ *' + p.titulo + '*\n\n';

      if (p.precoOriginal && p.precoAtual) {
        text += 'üî• De ' + p.precoOriginal + ' por *' + p.precoAtual + '*\n';
      } else if (p.precoAtual) {
        text += 'üî• Por *' + p.precoAtual + '*\n';
      }

      // OFERTA REL√ÇMPAGO com hor√°rio de expira√ß√£o
      if (p.destaque && p.destaque.includes('REL√ÇMPAGO') && p.ofertaExpiraEmLocal) {
        const expiraDate = new Date(p.ofertaExpiraEmLocal);
        const horas = expiraDate.getHours().toString().padStart(2, '0');
        const minutos = expiraDate.getMinutes().toString().padStart(2, '0');
        text += '‚ö°Ô∏è OFERTA REL√ÇMPAGO ‚Ä¢ Expira √†s ' + horas + ':' + minutos + '\n';
      } else if (p.destaque && p.destaque.includes('REL√ÇMPAGO')) {
        text += '‚ö°Ô∏è OFERTA REL√ÇMPAGO\n';
      }

      // S√≥ mostrar cupom se tiver cupomNome (cupom v√°lido com c√≥digo real)
      if (p.cupomNome) {
        text += '\nüéüÔ∏è Cupom: *' + p.cupomNome + '*\n';
        if (p.cupomDesconto) text += 'üí∞ Desconto do Cupom: ' + p.cupomDesconto + '\n';
        if (p.cupomLimite) text += 'üíµ Limite: ' + p.cupomLimite + '\n';
      }

      if (p.vendedor) {
        text += '\nüè™ Loja: ' + p.vendedor + '\n';
      }

      text += '\nüëâ *Clique no link e aproveite o desconto agora:*\n';
      text += SITE_BASE + 'p/' + p.id + '.html';

      return text;
    }

    function getScoreColor(score) {
      if (score >= 0.8) return '#25d366';
      if (score >= 0.6) return '#ffc107';
      if (score >= 0.4) return '#ff9800';
      return '#ff4444';
    }

    function renderPage() {
      const categories = CATEGORY_ORDER.filter(c => allData[c] && allData[c].length > 0);
      // Incluir categorias que existem nos dados mas n√£o est√£o na lista de order
      Object.keys(allData).forEach(c => {
        if (!categories.includes(c) && allData[c].length > 0) categories.push(c);
      });

      let totalProducts = 0;
      categories.forEach(c => totalProducts += allData[c].length);

      // Stats bar
      const refreshTime = serverLastRefresh ? new Date(serverLastRefresh).toLocaleTimeString('pt-BR') : '‚Äî';
      const now = new Date();
      const nextRefresh = now.getHours() < 8 ? '08:00' : (now.getHours() < 13 ? '13:00' : '08:00 (amanh√£)');
      document.getElementById('statsBar').innerHTML =
        '<span>Categorias: <strong>' + categories.length + '</strong></span>' +
        '<span>Produtos: <strong>' + totalProducts + '</strong></span>' +
        '<span>Atualizado: <strong>' + refreshTime + '</strong></span>' +
        '<span>Pr√≥ximo: <strong>' + nextRefresh + '</strong></span>';

      // Tabs
      const tabBar = document.getElementById('tabBar');
      tabBar.innerHTML = '';
      categories.forEach((cat, idx) => {
        const emoji = CATEGORY_EMOJIS[cat] || 'üì¶';
        const tab = document.createElement('div');
        tab.className = 'tab' + (idx === 0 ? ' active' : '');
        tab.dataset.cat = cat;
        tab.innerHTML = emoji + ' ' + cat + '<span class="badge">' + allData[cat].length + '</span>';
        tab.onclick = () => switchTab(cat);
        tabBar.appendChild(tab);
      });

      // Content
      const content = document.getElementById('content');
      content.innerHTML = '';
      categories.forEach((cat, idx) => {
        const section = document.createElement('div');
        section.className = 'category-section' + (idx === 0 ? ' active' : '');
        section.id = 'cat-' + slugify(cat);

        // Copy All button
        const copyAllBtn = document.createElement('button');
        copyAllBtn.className = 'copy-all-btn';
        copyAllBtn.textContent = 'üìã Copiar TODOS os ' + allData[cat].length + ' textos desta categoria';
        copyAllBtn.onclick = () => copyAllFromCategory(cat, copyAllBtn);
        section.appendChild(copyAllBtn);

        allData[cat].forEach((p, i) => {
          productMap[p.id] = p;
          section.appendChild(createProductCard(p, i + 1));
        });

        content.appendChild(section);
      });
    }

    function createProductCard(p, rank) {
      const card = document.createElement('div');
      card.className = 'product-card';

      const whatsText = buildWhatsText(p);
      const scorePercent = Math.round((p.score || 0) * 100);
      const scoreColor = getScoreColor(p.score || 0);

      let metaTags = '';
      if (p.cupomNome) metaTags += '<span class="meta-tag coupon">üéüÔ∏è ' + escHtml(p.cupomNome) + ' (' + escHtml(p.cupomDesconto || '') + ')</span>';
      if (p.vendedor) metaTags += '<span class="meta-tag seller">üè™ ' + escHtml(p.vendedor) + '</span>';
      if (p.destaque && p.destaque.includes('REL√ÇMPAGO') && p.ofertaExpiraEmLocal) {
        const exp = new Date(p.ofertaExpiraEmLocal);
        metaTags += '<span class="meta-tag highlight">‚ö° REL√ÇMPAGO at√© ' + exp.getHours().toString().padStart(2,'0') + ':' + exp.getMinutes().toString().padStart(2,'0') + '</span>';
      } else if (p.destaque) {
        metaTags += '<span class="meta-tag highlight">‚≠ê ' + escHtml(p.destaque) + '</span>';
      }
      if (p.frete) metaTags += '<span class="meta-tag">üöö ' + escHtml(p.frete) + '</span>';

      card.innerHTML =
        '<div class="product-inner">' +
          '<img class="product-img" src="' + escHtml(p.imagem || '') + '" alt="" loading="lazy" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23222%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23555%22 font-size=%2214%22>Sem img</text></svg>\'">' +
          '<div class="product-info">' +
            '<div class="product-title"><span class="rank-number">#' + rank + '</span>' + escHtml(p.titulo) + '</div>' +
            '<div class="product-prices">' +
              (p.precoOriginal ? '<span class="price-original">' + escHtml(p.precoOriginal) + '</span>' : '') +
              '<span class="price-current">' + escHtml(p.precoAtual || 'N/A') + '</span>' +
              (p.desconto ? '<span class="discount-badge">' + escHtml(p.desconto) + '</span>' : '') +
            '</div>' +
            '<div style="font-size:11px;color:#666;margin-top:2px;">' +
              'Score: ' + scorePercent + '%' +
              '<div class="score-bar"><div class="score-fill" style="width:' + scorePercent + '%;background:' + scoreColor + '"></div></div>' +
              (p.avaliacao ? ' | \u2b50 ' + p.avaliacao : '') +
              (p.vendas ? ' | \ud83d\uded2 ' + formatVendas(p.vendas) + ' vendas' : '') +
            '</div>' +
            '<div class="product-meta">' + metaTags + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="whats-text-area">' +
          '<pre class="whats-text">' + escHtml(whatsText) + '</pre>' +
        '</div>' +
        '<div class="share-btns">' +
          '<button class="share-btn" onclick="shareProduct(\'' + p.id + '\')" id="share-' + p.id + '">\ud83d\udcf2 Enviar com Imagem</button>' +
          '<a class="share-btn-secondary" href="https://wa.me/?text=' + encodeURIComponent(whatsText) + '" target="_blank" rel="noopener">\ud83d\udcac S\u00f3 Texto</a>' +
        '</div>';

      return card;
    }

    function switchTab(cat) {
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.cat === cat));
      document.querySelectorAll('.category-section').forEach(s => s.classList.remove('active'));
      const section = document.getElementById('cat-' + slugify(cat));
      if (section) section.classList.add('active');
    }

    function copyAllFromCategory(cat, btn) {
      const products = allData[cat] || [];
      const allTexts = products.map(p => buildWhatsText(p)).join('\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n');
      navigator.clipboard.writeText(allTexts).then(() => {
        btn.textContent = '‚úÖ Todos copiados!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'üìã Copiar TODOS os ' + products.length + ' textos desta categoria';
          btn.classList.remove('copied');
        }, 3000);
      });
    }

    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }

    function escHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatVendas(v) {
      const n = parseInt(v);
      if (isNaN(n)) return v;
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return String(n);
    }

    // ‚îÄ‚îÄ Compartilhar produto com imagem via Web Share API ‚îÄ‚îÄ
    async function shareProduct(productId) {
      const p = productMap[productId];
      if (!p) return;

      const btn = document.getElementById('share-' + productId);
      const originalText = btn.textContent;
      btn.textContent = '\u23f3 Carregando imagem...';
      btn.classList.add('loading');

      const whatsText = buildWhatsText(p);

      // Tentar Web Share API com arquivo de imagem
      if (navigator.share && navigator.canShare) {
        try {
          // Baixar imagem como blob
          const imageBlob = await fetchImageAsBlob(p.imagem);
          if (imageBlob) {
            const ext = imageBlob.type.includes('png') ? 'png' : 'jpg';
            const file = new File([imageBlob], 'produto.' + ext, { type: imageBlob.type });

            if (navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                text: whatsText,
              });
              btn.textContent = '\u2705 Enviado!';
              btn.classList.remove('loading');
              btn.classList.add('success');
              setTimeout(() => { btn.textContent = originalText; btn.classList.remove('success'); }, 3000);
              return;
            }
          }
        } catch (err) {
          if (err.name === 'AbortError') {
            btn.textContent = originalText;
            btn.classList.remove('loading');
            return; // usu\u00e1rio cancelou
          }
          console.log('Share com imagem falhou:', err);
        }
      }

      // Fallback: Copiar imagem pro clipboard + abrir WhatsApp com texto
      try {
        const imageBlob = await fetchImageAsBlob(p.imagem);
        if (imageBlob && navigator.clipboard && window.ClipboardItem) {
          // Converter para PNG para clipboard (clipboard s\u00f3 aceita PNG)
          const pngBlob = await convertToPng(imageBlob, p.imagem);
          await navigator.clipboard.write([
            new ClipboardItem({ 'image/png': pngBlob })
          ]);
          btn.textContent = '\u2705 Imagem copiada! Abrindo WhatsApp...';
          btn.classList.remove('loading');
          btn.classList.add('success');
          // Abrir WhatsApp com texto pr\u00e9-preenchido
          setTimeout(() => {
            window.open('https://wa.me/?text=' + encodeURIComponent(whatsText), '_blank');
          }, 500);
          setTimeout(() => { btn.textContent = originalText; btn.classList.remove('success'); }, 5000);
          return;
        }
      } catch (err) {
        console.log('Clipboard write falhou:', err);
      }

      // Fallback final: s\u00f3 abre wa.me com texto
      btn.textContent = originalText;
      btn.classList.remove('loading');
      window.open('https://wa.me/?text=' + encodeURIComponent(whatsText), '_blank');
    }

    // Baixar imagem como blob (com fallback via canvas para CORS)
    async function fetchImageAsBlob(url) {
      if (!url) return null;
      try {
        const res = await fetch(url);
        if (res.ok) return await res.blob();
      } catch (e) {
        // CORS bloqueado, tentar via canvas
      }
      return await loadImageViaCanvas(url);
    }

    // Carregar imagem via canvas (bypass CORS se poss\u00edvel)
    function loadImageViaCanvas(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          canvas.getContext('2d').drawImage(img, 0, 0);
          canvas.toBlob((blob) => resolve(blob), 'image/png');
        };
        img.onerror = () => resolve(null);
        img.src = url;
      });
    }

    // Converter qualquer imagem blob para PNG (necess\u00e1rio pro clipboard)
    function convertToPng(blob, url) {
      return new Promise((resolve) => {
        if (blob.type === 'image/png') { resolve(blob); return; }
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          canvas.getContext('2d').drawImage(img, 0, 0);
          canvas.toBlob((pngBlob) => resolve(pngBlob || blob), 'image/png');
          URL.revokeObjectURL(img.src);
        };
        img.onerror = () => resolve(blob);
        img.src = URL.createObjectURL(blob);
      });
    }

    loadProducts();
  </script>
</body>
</html>
