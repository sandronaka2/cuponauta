<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cuponauta - WhatsApp</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #075e54, #128c7e);
      padding: 20px 30px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 15px rgba(0,0,0,0.5);
    }

    .header h1 { font-size: 24px; color: #fff; margin-bottom: 5px; }
    .header p { font-size: 13px; color: #d1f5d3; }

    /* â”€â”€ Search & Filters â”€â”€ */
    .toolbar {
      background: #111;
      padding: 12px 20px;
      border-bottom: 1px solid #222;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      position: sticky;
      top: 76px;
      z-index: 100;
    }

    .search-wrapper {
      flex: 1;
      min-width: 200px;
      position: relative;
    }

    .search-box {
      width: 100%;
      padding: 10px 14px 10px 36px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .search-box:focus { border-color: #25d366; }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 14px;
      pointer-events: none;
    }

    .filter-btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #aaa;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .filter-btn:hover { border-color: #25d366; color: #fff; }
    .filter-btn.active { background: #25d366; color: #000; border-color: #25d366; }

    .results-count {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }

    /* â”€â”€ Tabs â”€â”€ */
    .tab-bar {
      display: flex;
      background: #0d0d0d;
      border-bottom: 1px solid #222;
      overflow-x: auto;
      position: sticky;
      top: 130px;
      z-index: 99;
    }

    .tab-bar::-webkit-scrollbar { height: 3px; }
    .tab-bar::-webkit-scrollbar-track { background: #111; }
    .tab-bar::-webkit-scrollbar-thumb { background: #25d366; border-radius: 3px; }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 13px;
      font-weight: 600;
      color: #888;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .tab:hover { color: #ccc; background: #1a1a1a; }
    .tab.active { color: #25d366; border-bottom-color: #25d366; }

    .tab .badge {
      background: #25d366;
      color: #000;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 10px;
      margin-left: 6px;
      font-weight: 700;
    }

    /* â”€â”€ Sort Bar â”€â”€ */
    .sort-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 20px;
      background: #111;
      border-bottom: 1px solid #222;
      overflow-x: auto;
    }

    .sort-label {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }

    .sort-btn {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #aaa;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .sort-btn:hover { border-color: #25d366; color: #fff; }
    .sort-btn.active { background: #25d366; color: #000; border-color: #25d366; }

    /* â”€â”€ Container â”€â”€ */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 15px;
    }

    .category-section { display: none; }
    .category-section.active {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    /* â”€â”€ Product Card â”€â”€ */
    .product-card {
      background: #161616;
      border: 1px solid #252525;
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .product-card:hover { border-color: #25d366; }
    .product-card.hidden { display: none; }

    .product-inner {
      display: flex;
      gap: 16px;
      padding: 16px;
    }

    .product-img {
      width: 110px;
      height: 110px;
      border-radius: 8px;
      object-fit: cover;
      background: #222;
      flex-shrink: 0;
    }

    .product-info { flex: 1; min-width: 0; }

    .product-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-prices {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .price-original { font-size: 12px; color: #666; text-decoration: line-through; }
    .price-current { font-size: 18px; font-weight: 700; color: #25d366; }

    .discount-badge {
      background: #ff4444;
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .product-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .meta-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      background: #1e1e1e;
      color: #aaa;
      border: 1px solid #333;
    }

    .meta-tag.coupon { background: #1a2e1a; color: #25d366; border-color: #25d366; }
    .meta-tag.seller { background: #1a1a2e; color: #6ea8fe; border-color: #3a3a5e; }
    .meta-tag.highlight { background: #2e1a1a; color: #ff6b6b; border-color: #5e3a3a; }
    .meta-tag.cupom-geral { background: #2e2e0a; color: #ffc107; border-color: #5e5e1a; font-weight: 700; }

    .price-with-coupon {
      font-size: 13px;
      color: #ffc107;
      font-weight: 700;
      margin-top: 2px;
    }

    .price-with-coupon .coupon-name {
      font-size: 11px;
      color: #999;
      font-weight: 400;
    }

    /* â”€â”€ Score â”€â”€ */
    .score-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      font-size: 11px;
      color: #666;
    }

    .score-bar {
      width: 60px;
      height: 5px;
      background: #333;
      border-radius: 3px;
      overflow: hidden;
    }

    .score-fill { height: 100%; border-radius: 3px; }
    .score-value { font-weight: 700; }
    .rank-number { font-size: 11px; font-weight: 700; color: #555; margin-right: 4px; }

    /* â”€â”€ WhatsApp Text Area â”€â”€ */
    .whats-text-area {
      background: #0d1117;
      border-top: 1px solid #252525;
      padding: 12px 16px;
    }

    .whats-text {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #c9d1d9;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
      user-select: all;
    }

    /* â”€â”€ Action Buttons â”€â”€ */
    .action-btns {
      display: flex;
      gap: 8px;
      padding: 10px 16px;
      background: #0d1117;
      border-top: 1px solid #1a1a2e;
    }

    .action-btn {
      flex: 1;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      border: none;
      color: #fff;
    }

    .action-btn:hover { transform: scale(1.02); }

    .btn-copy-img { background: #6c5ce7; }
    .btn-copy-img:hover { background: #5a4bd1; }

    .btn-copy-txt { background: #00b894; }
    .btn-copy-txt:hover { background: #00a381; }



    .action-btn.success { background: #1a8 !important; }
    .action-btn.error { background: #c44 !important; }

    /* â”€â”€ Stats â”€â”€ */
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 10px;
      background: #111;
      border-bottom: 1px solid #222;
      font-size: 12px;
      color: #666;
    }

    .stats-bar strong { color: #25d366; }

    /* â”€â”€ Loading â”€â”€ */
    .loading-section {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #25d366;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .no-results {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 15px;
    }

    /* â”€â”€ Mobile â”€â”€ */
    @media (max-width: 768px) {
      .category-section.active { grid-template-columns: 1fr; }
      .product-inner { flex-direction: column; align-items: center; text-align: center; }
      .product-img { width: 140px; height: 140px; }
      .product-prices { justify-content: center; }
      .product-meta { justify-content: center; }
      .header h1 { font-size: 20px; }
      .tab { padding: 10px 14px; font-size: 12px; }
      .toolbar { top: 68px; padding: 10px 12px; }
      .tab-bar { top: 120px; }
      .action-btns { flex-wrap: wrap; }
      .action-btn { min-width: calc(50% - 4px); }
      .score-row { flex-wrap: wrap; justify-content: center; }
      .sort-bar { padding: 8px 12px; gap: 6px; }
      .sort-btn { padding: 5px 10px; font-size: 11px; }
    }

    /* â”€â”€ Posted State â”€â”€ */
    .product-card.posted { opacity: 0.4; border-color: #1a5e1a; }
    .product-card.posted .product-title::before { content: 'âœ… '; }
    .btn-posted { background: #333; border: 1px solid #555; width: 40px; flex: none !important; font-size: 16px; }
    .btn-posted.active { background: #1a5e1a; border-color: #25d366; }

    /* â”€â”€ Cupons Tab â”€â”€ */
    @keyframes blinkTab { 0%, 100% { background: transparent; } 50% { background: rgba(255,68,68,0.3); } }
    .tab.has-new { animation: blinkTab 1s ease-in-out infinite; }
    .tab.has-new .badge { background: #ff4444; color: #fff; }

    .coupon-section { display: none; }
    .coupon-section.active { display: block; }

    .coupon-card {
      background: #161616;
      border: 2px solid #ff4444;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .coupon-name { font-size: 22px; font-weight: 800; color: #ff4444; margin-bottom: 12px; }

    .coupon-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .coupon-detail {
      font-size: 13px;
      color: #ccc;
      padding: 8px 12px;
      background: #1a1a1a;
      border-radius: 6px;
    }

    .coupon-detail strong { color: #25d366; }

    .coupon-text-preview {
      background: #0d1117;
      border: 1px solid #252525;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #c9d1d9;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
      max-height: 200px;
      overflow-y: auto;
    }

    .coupon-btns { display: flex; gap: 10px; flex-wrap: wrap; }

    .coupon-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      color: #fff;
      transition: all 0.2s;
      min-width: 140px;
      text-align: center;
    }

    .coupon-btn:hover { transform: scale(1.02); }
    .coupon-btn-new { background: #25d366; color: #000; }
    .coupon-btn-depleted { background: #ff4444; }
    .coupon-btn.success { background: #1a8 !important; color: #fff !important; }

    .no-coupons { text-align: center; padding: 60px 20px; color: #666; font-size: 15px; }

  </style>
</head>
<body>

  <div class="header">
    <h1>&#x1F916; Cuponauta WhatsApp</h1>
    <p>Todos os produtos v&aacute;lidos &mdash; prontos para copiar e enviar</p>
  </div>

  <div class="stats-bar" id="statsBar">
    <span>Carregando...</span>
  </div>

  <div class="toolbar" id="toolbar">
    <div class="search-wrapper">
      <span class="search-icon">&#x1F50D;</span>
      <input type="text" class="search-box" id="searchInput" placeholder="Buscar produto..." autocomplete="off">
    </div>
    <button class="filter-btn" id="couponFilter" onclick="toggleCouponFilter()">&#x1F3AB; S&oacute; com Cupom</button>
    <span class="results-count" id="resultsCount"></span>
  </div>

  <div class="tab-bar" id="tabBar"></div>

  <div class="sort-bar" id="sortBar">
    <span class="sort-label">Ordenar:</span>
    <button class="sort-btn active" data-sort="score" onclick="changeSort('score')">&#x1F3C6; Score</button>
    <button class="sort-btn" data-sort="vendasNum" onclick="changeSort('vendasNum')">&#x1F6D2; Vendidos</button>
    <button class="sort-btn" data-sort="avaliacaoNum" onclick="changeSort('avaliacaoNum')">&#x2B50; Avalia&ccedil;&atilde;o</button>
    <button class="sort-btn" data-sort="descontoNum" onclick="changeSort('descontoNum')">&#x1F4B0; Desconto</button>
  </div>

  <div class="container" id="content">
    <div class="loading-section">
      <div class="spinner"></div>
      Carregando produtos...
    </div>
  </div>

  <script>
    const RANGE_EMOJIS = {
      'Geral': '\ud83c\udf10',
      'At\u00e9 R$100': '\ud83d\udcb2',
      'R$100 \u2013 R$500': '\ud83d\udcb3',
      'R$500 \u2013 R$2.000': '\ud83d\udcb0',
      'R$2.000+': '\ud83d\udc8e',
    };

    const RANGE_ORDER = ['Geral', 'At\u00e9 R$100', 'R$100 \u2013 R$500', 'R$500 \u2013 R$2.000', 'R$2.000+'];

    let allData = {};
    let serverLastRefresh = null;
    const productMap = {};
    let couponFilterActive = false;
    let currentCategory = null;
    let searchTimeout = null;
    let currentSort = 'score';
    let cuponsGerais = [];

    // â”€â”€ Posted / Seen tracking (localStorage, daily) â”€â”€
    const TODAY_KEY = new Date().toISOString().slice(0, 10);
    const POSTED_KEY = 'cuponauta-posted-' + TODAY_KEY;
    const SEEN_KEY = 'cuponauta-seen-' + TODAY_KEY;

    function getPosted() { try { return JSON.parse(localStorage.getItem(POSTED_KEY) || '[]'); } catch { return []; } }
    function savePosted(list) { localStorage.setItem(POSTED_KEY, JSON.stringify(list)); }
    function isPosted(id) { return getPosted().includes(String(id)); }
    function getCouponsSeen() { try { return JSON.parse(localStorage.getItem(SEEN_KEY) || '[]'); } catch { return []; } }
    function saveCouponsSeen(list) { localStorage.setItem(SEEN_KEY, JSON.stringify(list)); }

    // Limpar chaves de dias anteriores
    Object.keys(localStorage).forEach(k => {
      if ((k.startsWith('cuponauta-posted-') || k.startsWith('cuponauta-seen-')) && !k.endsWith(TODAY_KEY)) {
        localStorage.removeItem(k);
      }
    });

    // â”€â”€ Load â”€â”€
    async function loadProducts() {
      try {
        const res = await fetch('products.json?t=' + Date.now());
        if (!res.ok) throw new Error('Erro HTTP ' + res.status);
        const json = await res.json();

        if (json.offline) {
          document.getElementById('content').innerHTML =
            '<div class="loading-section" style="color:#ffc107;">ðŸŒ™ ' + (json.offlineMessage || 'Sistema offline') + '</div>';
          document.getElementById('statsBar').innerHTML = '<span>ðŸŒ™ Offline &mdash; Voltamos Ã s 06:00</span>';
          return;
        }

        const products = json.products || [];
        allData = { 'Geral': products };
        RANGE_ORDER.forEach(r => { if (r !== 'Geral') allData[r] = []; });
        products.forEach(p => { if (p.faixa && allData[p.faixa]) allData[p.faixa].push(p); });
        serverLastRefresh = json.lastRefresh;
        cuponsGerais = json.cuponsGerais || [];
        renderPage();
      } catch (err) {
        document.getElementById('content').innerHTML =
          '<div class="loading-section" style="color:#ff4444;">Erro ao carregar: ' + err.message + '</div>';
      }
    }

    // â”€â”€ Build WhatsApp text â”€â”€
    function buildWhatsText(p) {
      let text = '';
      text += '\ud83e\udd16 *' + p.titulo + '*\n\n';

      if (p.precoOriginal && p.precoAtual) {
        text += '\ud83d\udd25 De ' + p.precoOriginal + ' por *' + p.precoAtual + '*\n';
      } else if (p.precoAtual) {
        text += '\ud83d\udd25 Por *' + p.precoAtual + '*\n';
      }

      // Cupom geral aplicado
      if (p.cupomGeral) {
        if (p.cupomGeral.atingeMinimo) {
          text += '\ud83c\udfab Com cupom *' + p.cupomGeral.nome + '* (' + p.cupomGeral.desconto + '): *' + p.cupomGeral.precoComCupomStr + '*\n';
        } else {
          text += '\ud83c\udfab Cupom *' + p.cupomGeral.nome + '* (' + p.cupomGeral.desconto + ') dispon\u00edvel (m\u00edn. R$' + p.cupomGeral.minimoNum + ')\n';
        }
      }

      if (p.destaque && p.destaque.includes('REL\u00c2MPAGO') && p.ofertaExpiraEmLocal) {
        const expiraDate = new Date(p.ofertaExpiraEmLocal);
        const horas = expiraDate.getHours().toString().padStart(2, '0');
        const minutos = expiraDate.getMinutes().toString().padStart(2, '0');
        text += '\u26a1\ufe0f OFERTA REL\u00c2MPAGO \u2022 Expira \u00e0s ' + horas + ':' + minutos + '\n';
      } else if (p.destaque && p.destaque.includes('REL\u00c2MPAGO')) {
        text += '\u26a1\ufe0f OFERTA REL\u00c2MPAGO\n';
      }

      if (p.cupomNome) {
        text += '\n\ud83c\udfab Cupom espec\u00edfico: *' + p.cupomNome + '*\n';
        if (p.cupomDesconto) text += '\ud83d\udcb0 Desconto do Cupom: ' + p.cupomDesconto + '\n';
        if (p.cupomLimite) text += '\ud83d\udcb5 Limite: ' + p.cupomLimite + '\n';
      }

      if (p.vendedor) {
        text += '\n\ud83c\udfea Loja: ' + p.vendedor + '\n';
      }

      text += '\n\ud83d\udc49 *Clique no link e aproveite o desconto agora:*\n';
      text += p.linkAfiliado;

      return text;
    }

    // â”€â”€ Score â”€â”€
    function getScoreColor(score) {
      if (score >= 70) return '#25d366';
      if (score >= 50) return '#ffc107';
      if (score >= 30) return '#ff9800';
      return '#ff4444';
    }

    function getScoreLabel(score) {
      if (score >= 80) return '\ud83d\udd25 Excelente';
      if (score >= 60) return '\u2b50 Bom';
      if (score >= 40) return '\ud83d\udc4d Regular';
      return '\u26a0\ufe0f Baixo';
    }

    // â”€â”€ Render â”€â”€
    function renderPage() {
      const ranges = RANGE_ORDER.filter(r => allData[r] && allData[r].length > 0);
      const totalProducts = allData['Geral'] ? allData['Geral'].length : 0;

      const refreshTime = serverLastRefresh ? new Date(serverLastRefresh).toLocaleTimeString('pt-BR') : '\u2014';
      document.getElementById('statsBar').innerHTML =
        '<span>Faixas: <strong>' + ranges.length + '</strong></span>' +
        '<span>Produtos: <strong>' + totalProducts + '</strong></span>' +
        '<span>Atualizado: <strong>' + refreshTime + '</strong></span>';

      // Tabs
      const tabBar = document.getElementById('tabBar');
      tabBar.innerHTML = '';
      ranges.forEach((cat, idx) => {
        const emoji = RANGE_EMOJIS[cat] || '\ud83d\udce6';
        const tab = document.createElement('div');
        tab.className = 'tab' + (idx === 0 ? ' active' : '');
        tab.dataset.cat = cat;
        tab.innerHTML = emoji + ' ' + cat + '<span class="badge">' + allData[cat].length + '</span>';
        tab.onclick = () => switchTab(cat);
        tabBar.appendChild(tab);
      });

      // Coupon tab
      const seen = getCouponsSeen();
      const hasNewCoupon = cuponsGerais.length > 0 && cuponsGerais.some(c => !seen.includes(c.nome));
      const couponTab = document.createElement('div');
      couponTab.className = 'tab' + (hasNewCoupon ? ' has-new' : '');
      couponTab.dataset.cat = '__cupons__';
      couponTab.innerHTML = '\ud83c\udf9f\ufe0f Cupons' + (cuponsGerais.length > 0 ? '<span class="badge">' + cuponsGerais.length + '</span>' : '');
      couponTab.onclick = () => switchTab('__cupons__');
      tabBar.appendChild(couponTab);

      if (!currentCategory) currentCategory = ranges[0];

      // Content
      const content = document.getElementById('content');
      content.innerHTML = '';
      ranges.forEach((cat, idx) => {
        const section = document.createElement('div');
        section.className = 'category-section' + (idx === 0 ? ' active' : '');
        section.id = 'cat-' + slugify(cat);
        section.dataset.range = cat;

        // Lazy render: only populate the first (active) section
        if (idx === 0) {
          renderSection(section, cat);
        }

        content.appendChild(section);
      });

      // Coupon section
      const couponSection = document.createElement('div');
      couponSection.className = 'coupon-section';
      couponSection.id = 'cat---cupons--';
      renderCouponSection(couponSection);
      content.appendChild(couponSection);

      updateResultsCount();
    }

    // â”€â”€ Create Card â”€â”€
    function createProductCard(p, rank) {
      const card = document.createElement('div');
      card.className = 'product-card' + (isPosted(p.id) ? ' posted' : '');
      card.dataset.id = p.id;
      card.dataset.titulo = (p.titulo || '').toLowerCase();
      card.dataset.hasCoupon = (p.cupomNome || p.cupom) ? '1' : '0';
      card.dataset.score = p.score || 0;
      card.dataset.vendasNum = p.vendasNum || 0;
      card.dataset.avaliacaoNum = p.avaliacaoNum || 0;
      card.dataset.descontoNum = p.descontoNum || 0;

      const whatsText = buildWhatsText(p);
      const score = p.score || 0;
      const scoreColor = getScoreColor(score);
      const scoreLabel = getScoreLabel(score);

      let metaTags = '';
      if (p.cupomNome) metaTags += '<span class="meta-tag coupon">\ud83c\udfab ' + escHtml(p.cupomNome) + (p.cupomDesconto ? ' (' + escHtml(p.cupomDesconto) + ')' : '') + '</span>';
      else if (p.cupom) metaTags += '<span class="meta-tag coupon">\ud83c\udfab ' + escHtml(p.cupom) + '</span>';
      if (p.vendedor) metaTags += '<span class="meta-tag seller">\ud83c\udfea ' + escHtml(p.vendedor) + '</span>';
      if (p.destaque && p.destaque.includes('REL\u00c2MPAGO') && p.ofertaExpiraEmLocal) {
        const exp = new Date(p.ofertaExpiraEmLocal);
        metaTags += '<span class="meta-tag highlight">\u26a1 REL\u00c2MPAGO at\u00e9 ' + exp.getHours().toString().padStart(2,'0') + ':' + exp.getMinutes().toString().padStart(2,'0') + '</span>';
      } else if (p.destaque) {
        metaTags += '<span class="meta-tag highlight">\u2b50 ' + escHtml(p.destaque) + '</span>';
      }
      if (p.frete) metaTags += '<span class="meta-tag">\ud83d\ude9a ' + escHtml(p.frete) + '</span>';
      if (p.cupomGeral) metaTags += '<span class="meta-tag cupom-geral">\ud83c\udfab ' + escHtml(p.cupomGeral.nome) + ' ' + escHtml(p.cupomGeral.desconto) + '</span>';

      card.innerHTML =
        '<div class="product-inner">' +
          '<img class="product-img" src="' + escHtml(p.imagem || '') + '" alt="" loading="lazy" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23222%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23555%22 font-size=%2214%22>Sem img</text></svg>\'">' +
          '<div class="product-info">' +
            '<div class="product-title"><span class="rank-number">#' + rank + '</span>' + escHtml(p.titulo) + '</div>' +
            '<div class="product-prices">' +
              (p.precoOriginal ? '<span class="price-original">' + escHtml(p.precoOriginal) + '</span>' : '') +
              '<span class="price-current">' + escHtml(p.precoAtual || 'N/A') + '</span>' +
              (p.desconto ? '<span class="discount-badge">' + escHtml(p.desconto) + '</span>' : '') +
            '</div>' +
            (p.cupomGeral && p.cupomGeral.atingeMinimo ? '<div class="price-with-coupon">\ud83c\udfab Com <strong>' + escHtml(p.cupomGeral.nome) + '</strong>: <strong>' + escHtml(p.cupomGeral.precoComCupomStr) + '</strong> <span class="coupon-name">(-R$' + p.cupomGeral.descontoValor.toFixed(2).replace('.', ',') + ')</span></div>' : '') +
            (p.cupomGeral && !p.cupomGeral.atingeMinimo ? '<div class="price-with-coupon" style="color:#888;">\ud83c\udfab <strong>' + escHtml(p.cupomGeral.nome) + '</strong> ' + escHtml(p.cupomGeral.desconto) + ' <span class="coupon-name">(m\u00edn. R$' + p.cupomGeral.minimoNum + ')</span></div>' : '') +
            '<div class="score-row">' +
              '<span class="score-value" style="color:' + scoreColor + '">' + score + '/100</span>' +
              '<div class="score-bar"><div class="score-fill" style="width:' + score + '%;background:' + scoreColor + '"></div></div>' +
              '<span>' + scoreLabel + '</span>' +
              (p.avaliacao ? ' | \u2b50 ' + p.avaliacao : '') +
              (p.vendas ? ' | \ud83d\uded2 ' + formatVendas(p.vendas) : '') +
            '</div>' +
            '<div class="product-meta">' + metaTags + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="whats-text-area">' +
          '<pre class="whats-text">' + escHtml(whatsText) + '</pre>' +
        '</div>' +
        '<div class="action-btns">' +
          '<button class="action-btn btn-copy-img" onclick="copyImage(\'' + p.id + '\', this)">\ud83d\uddbc\ufe0f Copiar Imagem</button>' +
          '<button class="action-btn btn-copy-txt" onclick="copyText(\'' + p.id + '\', this)">\ud83d\udcdd Copiar Texto</button>' +
          '<button class="action-btn btn-posted' + (isPosted(p.id) ? ' active' : '') + '" onclick="togglePosted(\'' + p.id + '\', this)">' + (isPosted(p.id) ? '\u2705' : '\u2610') + '</button>' +
        '</div>';

      return card;
    }

    // â”€â”€ Copy Text â”€â”€
    function copyText(productId, btn) {
      const p = productMap[productId];
      if (!p) return;
      const text = buildWhatsText(p);
      navigator.clipboard.writeText(text).then(() => {
        const orig = btn.textContent;
        btn.textContent = '\u2705 Texto copiado!';
        btn.classList.add('success');
        setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
      });
    }

    // â”€â”€ Copy Image â”€â”€
    async function copyImage(productId, btn) {
      const p = productMap[productId];
      if (!p || !p.imagem) return;

      const orig = btn.textContent;
      btn.textContent = '\u23f3 Copiando...';

      try {
        // Tentar fetch direto
        let blob = null;
        try {
          const res = await fetch(p.imagem);
          if (res.ok) blob = await res.blob();
        } catch(e) {}

        // Fallback via canvas
        if (!blob) blob = await loadImageViaCanvas(p.imagem);
        if (!blob) throw new Error('Imagem indispon\u00edvel');

        // Converter para PNG (clipboard s\u00f3 aceita PNG)
        const pngBlob = await convertToPng(blob);

        await navigator.clipboard.write([
          new ClipboardItem({ 'image/png': pngBlob })
        ]);

        btn.textContent = '\u2705 Imagem copiada!';
        btn.classList.add('success');
        setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
      } catch (err) {
        console.error('Erro ao copiar imagem:', err);
        btn.textContent = '\u274c Erro';
        btn.classList.add('error');
        setTimeout(() => { btn.textContent = orig; btn.classList.remove('error'); }, 2000);
      }
    }

    function loadImageViaCanvas(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          canvas.getContext('2d').drawImage(img, 0, 0);
          canvas.toBlob((blob) => resolve(blob), 'image/png');
        };
        img.onerror = () => resolve(null);
        img.src = url;
      });
    }

    function convertToPng(blob) {
      return new Promise((resolve) => {
        if (blob.type === 'image/png') { resolve(blob); return; }
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          canvas.getContext('2d').drawImage(img, 0, 0);
          canvas.toBlob((pngBlob) => resolve(pngBlob || blob), 'image/png');
          URL.revokeObjectURL(img.src);
        };
        img.onerror = () => resolve(blob);
        img.src = URL.createObjectURL(blob);
      });
    }

    // â”€â”€ Search â”€â”€
    document.getElementById('searchInput').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 200);
    });

    // â”€â”€ Coupon Filter â”€â”€
    function toggleCouponFilter() {
      couponFilterActive = !couponFilterActive;
      document.getElementById('couponFilter').classList.toggle('active', couponFilterActive);
      applyFilters();
    }

    // â”€â”€ Apply Filters â”€â”€
    function applyFilters() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const activeSection = document.querySelector('.category-section.active');
      if (!activeSection) return;
      const cards = activeSection.querySelectorAll('.product-card');

      cards.forEach(card => {
        const titulo = card.dataset.titulo || '';
        const hasCoupon = card.dataset.hasCoupon === '1';

        let show = true;
        if (query && !titulo.includes(query)) show = false;
        if (couponFilterActive && !hasCoupon) show = false;

        card.classList.toggle('hidden', !show);
      });

      updateResultsCount();
    }

    function updateResultsCount() {
      const activeSection = document.querySelector('.category-section.active');
      if (!activeSection) return;
      const total = activeSection.querySelectorAll('.product-card').length;
      const visible = activeSection.querySelectorAll('.product-card:not(.hidden)').length;
      const el = document.getElementById('resultsCount');
      if (visible === total) {
        el.textContent = total + ' produtos';
      } else {
        el.textContent = visible + ' de ' + total;
      }
    }

    // â”€â”€ Tab Switch â”€â”€
    function switchTab(cat) {
      currentCategory = cat;
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.cat === cat));
      document.querySelectorAll('.category-section, .coupon-section').forEach(s => s.classList.remove('active'));

      if (cat === '__cupons__') {
        const cs = document.getElementById('cat---cupons--');
        if (cs) cs.classList.add('active');
        // Mark all coupons as seen
        const seen = getCouponsSeen();
        cuponsGerais.forEach(c => { if (!seen.includes(c.nome)) seen.push(c.nome); });
        saveCouponsSeen(seen);
        document.querySelectorAll('.tab').forEach(t => { if (t.dataset.cat === '__cupons__') t.classList.remove('has-new'); });
        document.getElementById('resultsCount').textContent = cuponsGerais.length + ' cupons';
      } else {
        const section = document.getElementById('cat-' + slugify(cat));
        if (section) {
          section.classList.add('active');
          if (section.dataset.rendered !== 'true') {
            renderSection(section, section.dataset.range || cat);
          }
          if (currentSort !== 'score') changeSort(currentSort);
          applyFilters();
        }
      }
    }

    // â”€â”€ Utils â”€â”€
    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }

    function escHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatVendas(v) {
      const n = parseInt(v);
      if (isNaN(n)) return v;
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return String(n);
    }

    // â”€â”€ Render Section (lazy) â”€â”€
    function renderSection(section, rangeName) {
      section.innerHTML = '';
      const items = allData[rangeName] || [];
      items.forEach((p, i) => {
        productMap[p.id] = p;
        section.appendChild(createProductCard(p, i + 1));
      });
      section.dataset.rendered = 'true';
    }

    // â”€â”€ Sort â”€â”€
    function changeSort(field) {
      currentSort = field;
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === field));
      const section = document.querySelector('.category-section.active');
      if (!section) return;
      const cards = Array.from(section.querySelectorAll('.product-card'));
      cards.sort((a, b) => parseFloat(b.dataset[field] || 0) - parseFloat(a.dataset[field] || 0));
      cards.forEach((card, i) => {
        section.appendChild(card);
        const rankEl = card.querySelector('.rank-number');
        if (rankEl) rankEl.textContent = '#' + (i + 1);
      });
      updateResultsCount();
    }

    // â”€â”€ Posted Toggle â”€â”€
    function togglePosted(id, btn) {
      const posted = getPosted();
      const strId = String(id);
      const idx = posted.indexOf(strId);
      if (idx >= 0) posted.splice(idx, 1); else posted.push(strId);
      savePosted(posted);
      const card = btn.closest('.product-card');
      card.classList.toggle('posted', posted.includes(strId));
      btn.classList.toggle('active', posted.includes(strId));
      btn.textContent = posted.includes(strId) ? '\u2705' : '\u2610';
    }

    // â”€â”€ Coupon Section â”€â”€
    function renderCouponSection(container) {
      if (cuponsGerais.length === 0) {
        container.innerHTML = '<div class="no-coupons">\ud83c\udf9f\ufe0f Nenhum cupom geral ativo no momento</div>';
        return;
      }
      container.innerHTML = '';
      cuponsGerais.forEach(c => {
        const vmin = (c.valorMinimo || '').replace(/^Compra m\u00ednima\s*/i, '');
        const lim = (c.limite || '').replace(/^Limite de\s*/i, '');
        const newText = buildCouponNewText(c);
        const depletedText = buildCouponDepletedText(c);
        const card = document.createElement('div');
        card.className = 'coupon-card';
        card.innerHTML =
          '<div class="coupon-name">\ud83c\udf9f\ufe0f ' + escHtml(c.nome) + '</div>' +
          '<div class="coupon-details">' +
            '<div class="coupon-detail">\ud83d\udcb8 Desconto: <strong>' + escHtml(c.desconto) + '</strong></div>' +
            '<div class="coupon-detail">\u26a0\ufe0f M\u00ednimo: <strong>' + escHtml(vmin) + '</strong></div>' +
            '<div class="coupon-detail">\ud83d\udd1d Limite: <strong>' + escHtml(lim) + '</strong></div>' +
            '<div class="coupon-detail">\ud83d\udcca Tipo: <strong>' + escHtml(c.tipo) + '</strong></div>' +
          '</div>' +
          '<div style="margin-bottom:12px;">' +
            '<div style="font-size:12px;color:#888;margin-bottom:6px;">\ud83d\udccb Texto - Cupom Novo:</div>' +
            '<pre class="coupon-text-preview">' + escHtml(newText) + '</pre>' +
          '</div>' +
          '<div style="margin-bottom:12px;">' +
            '<div style="font-size:12px;color:#888;margin-bottom:6px;">\ud83d\udccb Texto - Cupom Esgotado:</div>' +
            '<pre class="coupon-text-preview">' + escHtml(depletedText) + '</pre>' +
          '</div>' +
          '<div class="coupon-btns">' +
            '<button class="coupon-btn coupon-btn-new" onclick="copyCouponText(this, \'' + escHtml(c.nome) + '\', \'new\')">\ud83d\udcdd Copiar Novo</button>' +
            '<button class="coupon-btn coupon-btn-depleted" onclick="copyCouponText(this, \'' + escHtml(c.nome) + '\', \'depleted\')">\ud83d\udcdd Copiar Esgotado</button>' +
          '</div>';
        container.appendChild(card);
      });
    }

    function buildCouponNewText(c) {
      const vmin = (c.valorMinimo || '').replace(/^Compra m\u00ednima\s*/i, '');
      const lim = (c.limite || '').replace(/^Limite de\s*/i, '');
      let t = '\ud83e\udd16 *CUPOM LIBERADO! Novo cupom fresquinho, cuponauta* \ud83d\udc9b\n\n';
      t += '\ud83d\udcb8 C\u00f3digo: *' + c.nome + '*\n';
      t += '\ud83c\udfaf Desconto: ' + c.desconto + '\n';
      t += '\u26a0\ufe0f Compra m\u00ednima: ' + vmin + '\n';
      t += '\ud83d\udd1d Limite de desconto: ' + lim + ' (m\u00e1ximo que voc\u00ea ganha)\n';
      t += '\ud83d\udcca Tipo: ' + c.tipo + ' (v\u00e1lido para a maioria dos produtos)\n';
      t += '\u23f3 Corre que \u00e9 por tempo limitado! \ud83d\ude80 Quem pega primeiro, leva!\n\n';
      t += 'Ative agora pela p\u00e1gina oficial do Mercado Livre antes de finalizar a compra e garanta seu desconto:\n';
      t += 'https://mercadolivre.com/sec/2EjzCDG';
      return t;
    }

    function buildCouponDepletedText(c) {
      let t = '\ud83d\ude29 CUPOM *' + c.nome + '* ESGOTADO! Infelizmente zerou total, galera \ud83d\udc94\n';
      t += 'Ele voou rapidinho como sempre nesses tops!\n\n';
      t += 'N\u00e3o desanima n\u00e3o: novos cupons, achados incr\u00edveis e promo\u00e7\u00f5es de produtos podem cair a qualquer momento aqui no grupo. Fica ligado nas notifica\u00e7\u00f5es e nos posts que eu aviso na hora que liberar algo fresco! \ud83d\udd75\ufe0f\u200d\u2642\ufe0f\ud83d\udd25\n\n';
      t += 'Bora economizar juntos! \ud83d\udc9b';
      return t;
    }

    function copyCouponText(btn, nome, type) {
      const c = cuponsGerais.find(x => x.nome === nome);
      if (!c) return;
      const text = type === 'new' ? buildCouponNewText(c) : buildCouponDepletedText(c);
      navigator.clipboard.writeText(text).then(() => {
        const orig = btn.textContent;
        btn.textContent = '\u2705 Copiado!';
        btn.classList.add('success');
        setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
      });
    }

    loadProducts();
  </script>
</body>
</html>
